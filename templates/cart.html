<!-- templates/cart.html -->
{% extends 'base.html' %}

{% block title %}Panier - Mon E-commerce{% endblock %}

{% block content %}
<h2>Votre Panier</h2>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}

{% if cart_items %}
    <table class="cart-table">
        <thead>
            <tr>
                <th>Produit</th>
                <th>Prix unitaire</th>
                <th>Quantit√©</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr>
                <td>
                    {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="cart-product-image">
                    {% endif %}
                    {{ item.product.name }}
                </td>
                <td>{{ item.product.price }} ‚Ç¨</td>
                <td>
                    <form method="post" action="{% url 'update_cart' item.product.id %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="99" style="width:60px;">
                        <button type="submit" name="action" value="update" class="btn-link">‚úì</button>
                    </form>
                </td>
                <td>{{ item.item_total }} ‚Ç¨</td>
                <td>
                    <form method="post" action="{% url 'update_cart' item.product.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" name="action" value="remove" class="btn-link" style="color:red;">üóëÔ∏è Supprimer</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="cart-total">
        <h3>Total : <strong>{{ total }} ‚Ç¨</strong></h3>
        <a href="/" class="btn">Continuer vos achats</a>
        <!-- Plus tard : lien vers la page de paiement -->
        <!-- Stripe Checkout -->
		<script src="https://js.stripe.com/v3/"></script>
		<script>
		document.addEventListener('DOMContentLoaded', function () {
			const stripe = Stripe('{{ stripe_publishable_key }}');
    
			document.getElementById('checkout-button').addEventListener('click', function () {
				fetch('/payment/create-checkout-session/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': '{{ csrf_token }}'
					},
				})
				.then(function(response) {
					return response.json();
				})
				.then(function(session) {
					return stripe.redirectToCheckout({ sessionId: session.id });
				})
				.catch(function(error) {
					console.error('Erreur:', error);
					alert('Une erreur est survenue lors du paiement.');
				});
			});
		});
		</script>

		<button id="checkout-button" class="btn btn-success" style="margin-left:1rem;">
			üí≥ Payer maintenant
		</button>
    </div>

{% else %}
    <p>Votre panier est vide.</p>
    <a href="/" class="btn">Voir les produits</a>
{% endif %}
{% endblock %}